version: '3'

services:

  db:
    networks:
      - internal
    labels:
      - traefik.enable=false

  keycloak:
    environment:
      - KEYCLOAK_USER=${TD_KEYCLOAK_USER}
      - KEYCLOAK_PASSWORD=${TD_KEYCLOAK_PASSWORD}
    networks:
      - internal
      - proxy
    labels:
      - traefik.backend=id
      - traefik.frontend.rule=Host:id.todarch.com
      - traefik.docker.network=proxy
      - traefik.port=8080

  cs:
    networks:
      - internal
    labels:
      - traefik.enable=false

  um:
    environment:
      - spring.profiles.active=prod
      - RABBITMQ_USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
    networks:
      - internal
    labels:
      - traefik.enable=false

  td:
    environment:
      - spring.profiles.active=prod
    networks:
      - internal
    labels:
      - traefik.enable=false

  gw:
    networks:
      - internal
      - proxy
    labels:
      - traefik.backend=gateway
      - traefik.frontend.rule=Host:api.todarch.com
      - traefik.docker.network=proxy
      - traefik.port=8080
      
  web:
    networks:
      - internal
      - proxy
    labels:
      - traefik.backend=ui
      - traefik.frontend.rule=Host:app.todarch.com, todarch.com
      - traefik.docker.network=proxy
      - traefik.port=80

  rp:
    image: traefik:1.7.3-alpine
    command: --api --docker  # Enables the web UI and tells Traefik to listen to docker
    ports:
      - "80:80"      # The HTTP port
      - "8080:8080"  # The Web UI (enabled by --api)
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # So that Traefik can listen to the Docker events
      - $PWD/traefik.toml:/traefik.toml
      - $PWD/acme.json:/acme.json
    networks:
      - proxy
    labels:
      - traefik.frontend.rule=Host:rp.todarch.com
      - traefik.port=8080

  mq:
    environment:
      - RABBITMQ_HIPE_COMPILE=1
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    networks:
      - internal
      - proxy
    labels:
      - traefik.backend=rabbitmq
      - traefik.frontend.rule=Host:mq.todarch.com
      - traefik.docker.network=proxy
      - traefik.port=15672

  cm:
    environment:
      - spring.profiles.active=prod
      - RABBITMQ_USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
    networks:
      - internal
    labels:
      - traefik.enable=false
    restart: always

networks:
  proxy: # docker network create proxy for the first time
    external: true
  internal:
    external: false
